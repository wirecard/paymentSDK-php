<!DOCTYPE html><html lang="en"><head><title>examples/payments/Paysafecard/reserve</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="examples/payments/Paysafecard/reserve"><meta name="groc-project-path" content="examples/payments/Paysafecard/reserve.php"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">examples/payments/Paysafecard/reserve.php</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-comment">/**
 * Shop System SDK:
 * - Terms of Use can be found under:
 * https://github.com/wirecard/paymentSDK-php/blob/master/_TERMS_OF_USE
 * - License can be found under:
 * https://github.com/wirecard/paymentSDK-php/blob/master/LICENSE
 */</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="paysafecard-reserve-transaction">Paysafecard reserve transaction</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This example displays the usage of reserve method for payment method paysafecard.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="required-objects">Required objects</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>To include the necessary files, we use the composer for PSR-4 autoloading.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/../../../vendor/autoload.php'</span>;
<span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/../../inc/common.php'</span>;
<span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/../../configuration/config.php'</span>;

<span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/../../inc/header.php'</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Wirecard</span>\<span class="hljs-title">PaymentSdk</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">AccountHolder</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Wirecard</span>\<span class="hljs-title">PaymentSdk</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">Amount</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Wirecard</span>\<span class="hljs-title">PaymentSdk</span>\<span class="hljs-title">Entity</span>\<span class="hljs-title">Redirect</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Wirecard</span>\<span class="hljs-title">PaymentSdk</span>\<span class="hljs-title">Response</span>\<span class="hljs-title">FailureResponse</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Wirecard</span>\<span class="hljs-title">PaymentSdk</span>\<span class="hljs-title">Response</span>\<span class="hljs-title">InteractionResponse</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Wirecard</span>\<span class="hljs-title">PaymentSdk</span>\<span class="hljs-title">Transaction</span>\<span class="hljs-title">PaysafecardTransaction</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Wirecard</span>\<span class="hljs-title">PaymentSdk</span>\<span class="hljs-title">TransactionService</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="transaction-related-objects">Transaction related objects</h3></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use the amount object as amount which has to be paid by the consumer.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-variable">$amount</span> = <span class="hljs-keyword">new</span> Amount(<span class="hljs-number">12.59</span>, <span class="hljs-string">'EUR'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there was a previous transaction, use the ID of this parent transaction as reference.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-variable">$parentTransactionId</span> = array_key_exists(<span class="hljs-string">'parentTransactionId'</span>, <span class="hljs-variable">$_POST</span>) ? <span class="hljs-variable">$_POST</span>[<span class="hljs-string">'parentTransactionId'</span>] : <span class="hljs-keyword">null</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set redirect URLs for success, cancel and failure.
From payment page you will be redirected to:
Success URL when the payment is approved.
Cancel URL when the user cancels the transaction on payment page.
Failure URL when payment is not approved or the data are missing or incorrect</p></div></div><div class="code"><div class="wrapper"><span class="hljs-variable">$redirectUrls</span> = <span class="hljs-keyword">new</span> Redirect(
    getUrl(<span class="hljs-string">'return.php?status=success'</span>),
    getUrl(<span class="hljs-string">'return.php?status=cancel'</span>),
    getUrl(<span class="hljs-string">'return.php?status=failure'</span>)
);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>As soon as the transaction status changes, a server-to-server notification will get delivered to this URL.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-variable">$notificationUrl</span> = getUrl(<span class="hljs-string">'notify.php'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Account holder with last name and the crm id of your customer</p></div></div><div class="code"><div class="wrapper"><span class="hljs-variable">$accountHolder</span> = <span class="hljs-keyword">new</span> AccountHolder();
<span class="hljs-variable">$accountHolder</span>-&gt;setCrmId(<span class="hljs-number">20</span>);
<span class="hljs-variable">$accountHolder</span>-&gt;setLastName(<span class="hljs-string">'Doe'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="transaction">Transaction</h3></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The Paysafecard transaction holds all transaction relevant data for the reserve process.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-variable">$tx</span> = <span class="hljs-keyword">new</span> PaysafecardTransaction();
<span class="hljs-variable">$tx</span>-&gt;setNotificationUrl(<span class="hljs-variable">$notificationUrl</span>);
<span class="hljs-variable">$tx</span>-&gt;setRedirect(<span class="hljs-variable">$redirectUrls</span>);
<span class="hljs-variable">$tx</span>-&gt;setAmount(<span class="hljs-variable">$amount</span>);
<span class="hljs-variable">$tx</span>-&gt;setParentTransactionId(<span class="hljs-variable">$parentTransactionId</span>);
<span class="hljs-variable">$tx</span>-&gt;setAccountHolder(<span class="hljs-variable">$accountHolder</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="transaction-service">Transaction Service</h3></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The service is used to execute the reserve operation itself. A response object is returned.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-variable">$transactionService</span> = <span class="hljs-keyword">new</span> TransactionService(<span class="hljs-variable">$config</span>);
<span class="hljs-variable">$response</span> = <span class="hljs-variable">$transactionService</span>-&gt;reserve(<span class="hljs-variable">$tx</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="response-handling">Response handling</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The response of the service must be handled depending on it&#39;s class
In case of an <code>InteractionResponse</code>, a browser interaction by the consumer is required
in order to continue the reserve process. In this example we proceed with a header redirect
to the given <em>redirectUrl</em>. IFrame integration using this URL is also possible.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$response</span> <span class="hljs-keyword">instanceof</span> InteractionResponse) {
    <span class="hljs-keyword">die</span>(<span class="hljs-string">"&lt;meta http-equiv='refresh' content='0;url={$response-&gt;getRedirectUrl()}'&gt;"</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The failure state is represented by a FailureResponse object.
In this case the returned errors should be stored in your system.</p></div></div><div class="code"><div class="wrapper">} <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$response</span> <span class="hljs-keyword">instanceof</span> FailureResponse) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>In our example we iterate over all errors and echo them out. You should display them as
error, warning or information based on the given severity.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$response</span>-&gt;getStatusCollection() <span class="hljs-keyword">as</span> <span class="hljs-variable">$status</span>) {
        <span class="hljs-comment">/**
         * <span class="hljs-doctag">@var</span> $status \Wirecard\PaymentSdk\Entity\Status
         */</span>
        <span class="hljs-variable">$severity</span> = ucfirst(<span class="hljs-variable">$status</span>-&gt;getSeverity());
        <span class="hljs-variable">$code</span> = <span class="hljs-variable">$status</span>-&gt;getCode();
        <span class="hljs-variable">$description</span> = <span class="hljs-variable">$status</span>-&gt;getDescription();
        <span class="hljs-keyword">echo</span> sprintf(<span class="hljs-string">'%s with code %s and message "%s" occurred.&lt;br&gt;'</span>, <span class="hljs-variable">$severity</span>, <span class="hljs-variable">$code</span>, <span class="hljs-variable">$description</span>);
    }
}

<span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/../../inc/footer.php'</span>;</div></div></div></div></body></html>