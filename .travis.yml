dist: trusty
sudo: false
language: php
addons:
  sonarqube:
    token:
      secure: "hKcQzHpVXNNI3pxvlIotHq8ACASUfbs7OLK6ypoUG+XMbPuwUM30Ys2YKbwy52spLifkj10U7PDgXCo6X5oCgTSMHz5bk1WyhBHvoernulcehETDsSFj1ez1dsqkjAjtQk/bazYsfH9lXUVWL/DkkCgkufPSzu0utjPVPP8v8zMa/I9287yCqisJ4gojzNfqxzf5f348UXKuhj1pAgNKHw+Q/4O3noYImmoJurQe05pfzvcFVeEvTsUH0nxWAHKZrhT8KqJvHpCuNeuk4vsq3bq7luko79NG80EwrGia/5WaqhJV0c6vtflPn98LAm8lvJWRUGkZ419Ol7M9ub7eKpGSaQ8kjdEVfzJsdpHWWlIfnEcSZkrYDLuYR2mkdZkWuzM1kdV3Or53x4FddVe5+TXQ+aCqmUanQ2B9Sw9RIrY7vhdM7DLacavlRtwihcZtE8QXF5LTa+8gMEvpaFQsDstk//80xPqdgOow2x95gTDjrirEqILrEPESJKg9NuTNDVP5rxwSSNjoFOSC+36/5cOs/jn8oFMfsnjHkjBn1HNeAnxUj5LPP6Z5ejq6nMdkar7QZqEV4JYqXNEMccMhxTslo0RFPkfFWREzhuf5G3cyzlhJS0HQgjnawv4oRYkDoRH4iUUJJvtLgOq89vaH1Hs6Facth8L5liVPvSnN3X0="

cache:
  directories:
    - $HOME/.composer/cache
    - $HOME/.sonar/cache

env:
  global:
  - COMPOSER_ARGS="--no-interaction"
matrix:
  include:
  - php: 5.6
    env:
    - TEST_COVERAGE=true
  - php: 7
    env:
    - CHECK_CS=true
  - php: 7.1
    env:
    - SONAR_SCAN=true
  - php: hhvm
before_install:
  - travis_retry composer self-update
install:
  - if [[ $TEST_COVERAGE == 'true' ]]; then travis_retry composer require --dev $COMPOSER_ARGS satooshi/php-coveralls:^1.0 ; fi
  - travis_retry composer install $COMPOSER_ARGS
  - composer show
script:
  - if [[ $TEST_COVERAGE == 'true' || ($SONAR_SCAN == 'true' && $TRAVIS_BRANCH == 'master')]]; then composer test-coverage ; else composer test ; fi
  - if [[ $CHECK_CS == 'true' ]]; then composer cs-check ; fi
  - if [[ $SONAR_SCAN == 'true' && $TRAVIS_BRANCH == 'master' ]]; then sonar-scanner ; fi
  - if [[ $SONAR_SCAN == 'true' && $TRAVIS_PULL_REQUEST != 'false' ]]; then sonar-scanner -Dsonar.analysis.mode=preview -Dsonar.github.pullRequest=$TRAVIS_PULL_REQUEST -Dsonar.github.oauth=$GITHUB_TOKEN -Dsource.skip=false ; fi

after_script:
  - if [[ $TEST_COVERAGE == 'true' ]]; then travis_retry composer upload-coverage ; fi

after_success:
  - if [ $TRAVIS_PHP_VERSION = '5.6' ] && [ $TRAVIS_BRANCH = 'master' ] && [ $TRAVIS_PULL_REQUEST = 'false' ]; then bash .bin/generate-docs.sh; fi

before_deploy:
  - bash .bin/generate-release-package.sh $TRAVIS_TAG
  - ls -lah target

deploy:
  provider: releases
  api_key:
    secure: BOCYBPIqK0gpRmPf34Nj2nOWjpqEO7s63AKw0Ct/sN6MPaaIX/Op/REJMx4jTj74QpSRKNfaKsn4a2IL42eh96H3fJJp8nRXoycwC9EK4SFF53PxOn6VuSpvyAqTYash5efmlmFQgxYfEsqZbuT9ogPVfHKwIQRyOZkERXCX+pEYsGnNW7K0gw/2X5wSgSXvEtTW58sh4K1ewJQpUXTxgN9B72Kcu9nZuLckusWuKle/4rhfmMX284Hel8DsjA55ENg6CtrCeQR16RYMDs/+J7LwStonByDVXYhi4frPL5SB5/MFXzi3qHDMMp9WV1ihrNT0ho5rMgcZwReiFdCVEsTN3mVAIYhuGtKWkAIP3JHzv4prONEeBv66drr6l/OOBkeB1V0QCm9c+dvDiDbvAt7GMh6Jtq8nsEmue421GUcsWLwTa01iROkyfEAkmidKZULMDjUArVrcEwd1Gxd2v4mXQGJkJepGOOjZi/FbnPHGoZ9KaBm4IX5b52CjrMeg+JHxEKv8dvUGl1lZULYMrkRuLbAyrUsuEodyygYliY6sJUFPCjsuEYumw3N6yEkn2+c2WZjsbB7Igv0F/B6kRItUR7TIQvR7svioJaaydHf6dFFOBh8rrcDvmOimB7vvIRr0cmkyAH2PvW5/uYFqcr17epU3c0ZV7nhApoVOeSM=
  file: target/wirecard-paymentSDK-php-$TRAVIS_TAG.zip
  skip_cleanup: true
  on:
    repo: wirecard/paymentSDK-php
    tags: true